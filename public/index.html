<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Nas Menu</title>
    
    <link rel="stylesheet" href="css/bootstrap-4.1.3.min.css" type="text/css">

    <script src="libs/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="libs/popper.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" type="text/javascript"></script>
    <script src="libs/bootstrap-4.1.3.min.js" type="text/javascript"></script>
    
    <link rel="stylesheet" href="css/main.css" type="text/css">

  </head>
  <body>
  
    <div id="nm-content">
      <div id="nm-header">
                                      
        <div class="dropdown" id="nm-top-menu">
          <button type="button " class="btn btn-primary btn-info dropdown-toggle" data-toggle="dropdown">
            Pages <span class="badge badge-warning">5</span>
          </button>
          <div id="page-menu" class="dropdown-menu"></div>
        </div>

        
        <div id="nm-top-title"></div>
        <div id="nm-top-info"></div>
      </div>
      
    </div>
    
    <script type="text/javascript">
      template_row = '<span class="nm-box nm-box-info"><span class="nm-box-content" data-path="{0}" >{1}</span></span>'
      transition_ms = 200;
      
      // a pythonesque format method
      if (!String.prototype.format) {
          String.prototype.format = function() {
              var args;
              args = arguments;
              if (args.length === 1 && args[0] !== null && typeof args[0] === 'object') {
                  args = args[0];
              }
              return this.replace(/{([^}]*)}/g, function(match, key) {
                  return (typeof args[key] !== "undefined" ? args[key] : match);
              });
          };
      }
      
      function basename(str) {
        return str.substr(str.lastIndexOf("/") + 1);
      }
      
      function dateTime() {
        $("#nm-top-info").html(new Date().toLocaleString());
      }
      
      function show_page(name) {
        $(".nm-box-container").hide();
        $("#nm-page-" + name).show();
        $("#nm-top-title").html(name);
        
        $.get("filelist?pgname=" + name, (d, status) => {
          var handler;
          if (d.type == 'file') handler = fileHandler;
          if (d.type == 'bin' || d.type == 'status')  handler = binHandler;
          
          if (d.type == 'file' || d.type == 'bin') {
            $("#nm-page-" + name).empty();
            d.data.forEach((e) => {
              $("#nm-page-" + name).append(template_row.format(e, basename(e)));
              });
            $(".nm-box-info").click({pgname:name, contentHandler:handler}, infoToggle);
          }
          
          if (d.type == 'status') {
            $("#nm-page-" + name).empty();
            d.data.forEach((e) => {
              $("#nm-page-" + name).append(template_row.format(e, basename(e)));
              });
            $(".nm-box-info").click({pgname:name, contentHandler:handler}, infoToggle);
          }
          
        }, "json");
      }
      
      function init_pages() {
        var template_mitem = '<a class="dropdown-item" href="#" data-pg="{0}">{0}</a>';
        var template_page = '<div class="nm-box-container" id="nm-page-{0}"></div>';
        
        $.get("pgnames", (d, status) => {
          d.forEach((e) => {
            $("#page-menu").append(template_mitem.format(e));
            $("#nm-content").append(template_page.format(e));
            });
            
          // click events
          $('a[data-pg]').each(function (d) {
            $(this).click(function (e) {
              var selected = $(this).attr("data-pg");
              show_page(selected);
              });
            });
            
          // start page
          $.get("pgstart", (d, status) => {
            show_page(d);
            }, "text");
          }, "json");
        
      }
      
      // gets content of file
      function fileHandler(o, pgname) {
        $.get("fileOutput", {pgname:pgname, fpath:$(o).find(".nm-box-content").attr("data-path"), start: 0}, (d, status) => {
          $(o).append("<pre>" + d.data + "</pre>");
        }, "json");
      }
      
      // gets output of binary
      function binHandler(o, pgname) {
        $.get("binOutput", {pgname:pgname, fpath:$(o).find(".nm-box-content").attr("data-path")}, (d, status) => {
          $(o).append("<pre>" + d.data.stdio + "\n\nStatus:" + d.data.status + "</pre>");
        }, "json");
      }
      
      var infoHidden = true;
      function infoToggle(e) {
        if(infoHidden) {
          $(".nm-box-info").not(this).hide(transition_ms);
          e.data.contentHandler(this, e.data.pgname);
          infoHidden = false;
        } else {
          $(".nm-box-info pre").remove();
          $(".nm-box-info").show(transition_ms);
          infoHidden = true;
        }
      }
      
      function setup() {
        dateTime();
        setInterval(dateTime, 950);
        
        init_pages();
            
        // set up pages
        // raise up start page
        
      }
      
      $(document).ready(setup);
    </script>

  </body>
</html>
